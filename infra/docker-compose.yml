version: '3.8'

# FunctionalFit Calendar - Docker Compose Configuration
# Complete production-ready stack with all necessary services

services:
  # ============================================================================
  # NGINX - Reverse Proxy and Static File Server
  # ============================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: functionalfit_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-8080}:80"
    volumes:
      # Nginx configuration
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # Frontend static files (built assets)
      - ../frontend/dist:/var/www/frontend:ro
      # Backend public directory (Laravel entry point)
      - ../backend/public:/var/www/backend/public:ro
      # SSL certificates (if needed)
      - ./nginx/ssl:/etc/nginx/ssl:ro
      # Logs
      - ./logs/nginx:/var/log/nginx
    depends_on:
      php-fpm:
        condition: service_healthy
    networks:
      - frontend-network
      - backend-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # PHP-FPM - Laravel Application Server
  # ============================================================================
  php-fpm:
    build:
      context: ../backend
      dockerfile: ../infra/docker/php/Dockerfile
      args:
        PHP_VERSION: 8.3
    container_name: functionalfit_php
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      # Mount entire backend for development hot-reload
      - ../backend:/var/www/html
      # PHP configuration
      - ./docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ./docker/php/php-fpm.conf:/usr/local/etc/php-fpm.d/zz-custom.conf:ro
      # Application logs
      - ./logs/laravel:/var/www/html/storage/logs
    environment:
      # Laravel environment
      APP_ENV: ${APP_ENV:-local}
      APP_KEY: ${APP_KEY}
      APP_DEBUG: ${APP_DEBUG:-true}
      APP_URL: ${APP_URL:-http://localhost:8080}

      # Database connection
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-functionalfit_db}
      DB_USERNAME: ${DB_USERNAME:-functionalfit}
      DB_PASSWORD: ${DB_PASSWORD}

      # Redis connection
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-null}
      REDIS_PORT: 6379
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis

      # Mail configuration
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-FunctionalFit}

      # Google Calendar API
      GOOGLE_CALENDAR_CLIENT_ID: ${GOOGLE_CALENDAR_CLIENT_ID}
      GOOGLE_CALENDAR_CLIENT_SECRET: ${GOOGLE_CALENDAR_CLIENT_SECRET}
      GOOGLE_CALENDAR_REDIRECT_URI: ${GOOGLE_CALENDAR_REDIRECT_URI}

      # WooCommerce/Stripe webhooks
      WOOCOMMERCE_WEBHOOK_SECRET: ${WOOCOMMERCE_WEBHOOK_SECRET}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}

      # Application settings
      TIMEZONE: ${TIMEZONE:-Europe/Budapest}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend-network
      - data-network
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # MySQL - Database Server
  # ============================================================================
  mysql:
    image: mysql:8.0
    container_name: functionalfit_mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-functionalfit_db}
      MYSQL_USER: ${DB_USERNAME:-functionalfit}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
      TZ: UTC
    volumes:
      # Persistent database storage
      - mysql-data:/var/lib/mysql
      # Custom MySQL configuration for optimization
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
      # Initialization scripts
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
      # Database backups
      - ./backups/mysql:/backups
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    networks:
      - data-network
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-connections=200
      --innodb-buffer-pool-size=256M
      --innodb-log-file-size=64M
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================================
  # Redis - Cache and Queue Backend
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: functionalfit_redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-functionalfit_redis_secret}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
    volumes:
      # Persistent Redis data (AOF for durability)
      - redis-data:/data
      # Custom Redis configuration
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - data-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================================================
  # Queue Worker - Laravel Queue Processing
  # ============================================================================
  queue-worker:
    build:
      context: ../backend
      dockerfile: ../infra/docker/php/Dockerfile
      args:
        PHP_VERSION: 8.3
    container_name: functionalfit_queue
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ../backend:/var/www/html
      - ./logs/queue:/var/www/html/storage/logs
    environment:
      # Same environment as PHP-FPM
      APP_ENV: ${APP_ENV:-local}
      APP_KEY: ${APP_KEY}
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-functionalfit_db}
      DB_USERNAME: ${DB_USERNAME:-functionalfit}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-null}
      REDIS_PORT: 6379
      QUEUE_CONNECTION: redis
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-FunctionalFit}
    depends_on:
      php-fpm:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend-network
      - data-network
    command: >
      sh -c "php artisan queue:work redis
      --tries=3
      --max-jobs=1000
      --max-time=3600
      --timeout=300
      --memory=256
      --sleep=3
      --queue=default,notifications,gcal-sync,webhooks
      --verbose"
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[q]ueue:work' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # Scheduler - Laravel Task Scheduler (Cron)
  # ============================================================================
  scheduler:
    build:
      context: ../backend
      dockerfile: ../infra/docker/php/Dockerfile
      args:
        PHP_VERSION: 8.3
    container_name: functionalfit_scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ../backend:/var/www/html
      - ./logs/scheduler:/var/www/html/storage/logs
      - ./docker/scheduler/crontab:/etc/crontabs/www-data:ro
    environment:
      # Same environment as PHP-FPM
      APP_ENV: ${APP_ENV:-local}
      APP_KEY: ${APP_KEY}
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-functionalfit_db}
      DB_USERNAME: ${DB_USERNAME:-functionalfit}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-null}
      REDIS_PORT: 6379
    depends_on:
      php-fpm:
        condition: service_healthy
    networks:
      - backend-network
      - data-network
    command: >
      sh -c "crond -f -l 2"
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[c]rond' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # Frontend Builder (Development only)
  # ============================================================================
  frontend-dev:
    build:
      context: ../frontend
      dockerfile: ../infra/docker/frontend/Dockerfile.dev
    container_name: functionalfit_frontend
    restart: unless-stopped
    working_dir: /app
    volumes:
      # Mount frontend for hot-reload
      - ../frontend:/app
      - /app/node_modules
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8080/api}
      VITE_APP_NAME: ${VITE_APP_NAME:-FunctionalFit}
    ports:
      - "${VITE_PORT:-5173}:5173"
    networks:
      - frontend-network
    command: npm run dev -- --host 0.0.0.0
    profiles:
      - dev

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  # Frontend network: Nginx <-> Frontend dev server (dev only)
  frontend-network:
    driver: bridge
    name: functionalfit_frontend

  # Backend network: Nginx <-> PHP-FPM <-> Queue Workers
  backend-network:
    driver: bridge
    name: functionalfit_backend

  # Data network: Application services <-> Database & Cache
  data-network:
    driver: bridge
    name: functionalfit_data

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  # MySQL persistent storage
  mysql-data:
    driver: local
    name: functionalfit_mysql_data

  # Redis persistent storage (AOF)
  redis-data:
    driver: local
    name: functionalfit_redis_data
